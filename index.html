<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>STACHUS: PROTOCOL V19 (FULL MOBILE TOUCH)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Share+Tech+Mono&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Playfair+Display:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        /* ================= GLOBAL SETTINGS ================= */
        :root { 
            --bg-color: #050505; 
            --text-main: #e0e0e0; 
            --font-title: 'Black Ops One', cursive;
            --font-mono: 'Space Mono', monospace;          
            --font-tech: 'Share Tech Mono', monospace;     
            --font-serif: 'Playfair Display', serif;
            --accent-green: #00ff41; 
            --alert-red: #ff0055; 
            --neon-blue: #00f7ff;    
        }

        * { box-sizing: border-box; margin: 0; padding: 0; cursor: crosshair; }
        
        body, html { 
            width: 100%; height: 100%; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: var(--font-mono); 
            overflow: hidden; 
            overscroll-behavior: none; /* 禁止橡皮筋效果 */
        }

        /* ================= NAVIGATION & LAYOUT ================= */
        .game-section { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background: var(--bg-color); z-index: 1;
            opacity: 0; pointer-events: none; 
            transition: opacity 0.6s cubic-bezier(0.22, 1, 0.36, 1); 
        }

        .game-section.active { opacity: 1; pointer-events: auto; z-index: 10; }

        .back-btn {
            position: absolute; top: 40px; left: 40px;
            font-family: var(--font-tech); color: #666; font-size: 14px;
            cursor: pointer; border: 1px solid #333; padding: 5px 15px;
            transition: 0.3s; z-index: 100; display: none; 
        }
        .back-btn:hover { border-color: var(--neon-blue); color: var(--neon-blue); }

        .next-phase-btn {
            position: absolute; bottom: 40px; right: 40px;
            font-family: var(--font-tech); color: var(--accent-green); font-size: 14px;
            cursor: pointer; border: 1px solid var(--accent-green); padding: 10px 20px;
            background: rgba(0,0,0,0.8); z-index: 90;
            animation: pulse-border 2s infinite;
        }
        .next-phase-btn:hover { background: var(--accent-green); color: #000; }

        @keyframes pulse-border { 0% {box-shadow: 0 0 0 0 rgba(0, 255, 65, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(0, 255, 65, 0);} 100% {box-shadow: 0 0 0 0 rgba(0, 255, 65, 0);} }

        /* ================= HUD LAYER (TOP RIGHT) ================= */
        #hud-layer { 
            position: fixed; inset: 0; pointer-events: none; z-index: 99; 
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 3px, 3px 100%;
        }
        .hud-corner { position: absolute; width: 30px; height: 30px; border: 2px solid #555; opacity: 0.5; }
        .tl { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .tr { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .bl { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .br { bottom: 20px; right: 20px; border-left: none; border-top: none; }

        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: rgba(0, 255, 65, 0.3); opacity: 0.5; animation: scan 6s linear infinite; }
        @keyframes scan { 0% {top: -10%;} 100% {top: 110%;} }

        /* HUD & DROPDOWN (RIGHT) */
        .hud-container {
            position: absolute; top: 30px; right: 40px;
            pointer-events: auto; z-index: 101; text-align: right;
        }
        .hud-trigger {
            font-family: var(--font-tech); font-size: 12px; color: var(--accent-green);
            border: 1px solid var(--accent-green); padding: 5px 10px;
            background: rgba(0, 20, 0, 0.8); cursor: pointer; letter-spacing: 2px;
            text-transform: uppercase; display: inline-block; transition: 0.2s;
            animation: border-flicker 3s infinite;
        }
        .hud-trigger:hover { background: var(--accent-green); color: #000; box-shadow: 0 0 10px var(--accent-green); }
        .hud-trigger::before { content: "[ + ] "; }
        .hud-trigger.active::before { content: "[ - ] "; }

        .hud-details {
            margin-top: 10px; font-family: var(--font-mono); font-size: 10px; color: #bbb;
            background: rgba(0, 0, 0, 0.9); border-right: 2px solid var(--alert-red); padding: 10px;
            display: none; max-width: 250px; backdrop-filter: blur(5px); line-height: 1.6;
            margin-left: auto;
        }
        .hud-details.visible { display: block; animation: slide-down 0.3s ease-out; }
        .hud-label { color: var(--alert-red); font-weight: bold; display: block; margin-top: 5px; letter-spacing: 1px; }
        .hud-value { color: var(--neon-blue); text-shadow: 0 0 2px var(--neon-blue); }

        @keyframes border-flicker { 0%, 100% { border-color: var(--accent-green); opacity: 1; } 50% { border-color: transparent; opacity: 0.7; } 52% { border-color: var(--accent-green); opacity: 1; } }
        @keyframes slide-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .hud-data-br { position: absolute; bottom: 25px; right: 60px; text-align: right; font-family: var(--font-tech); font-size: 10px; color: var(--accent-green); letter-spacing: 1px; opacity: 0.8; }

        /* ================= SLIDE STYLES ================= */
        #slide-cover { background: radial-gradient(circle at center, #111 0%, #000 90%); }
        .glitch-title { 
            font-family: var(--font-title); font-size: 10vw; color: #fff; 
            text-transform: uppercase; letter-spacing: -2px; line-height: 0.9;
            text-shadow: 4px 4px 0px rgba(255, 0, 85, 0.5);
            animation: glitch-skew 3s infinite linear alternate-reverse;
        }
        @keyframes glitch-skew { 0% { transform: skew(0deg); } 20% { transform: skew(-2deg); } 40% { transform: skew(2deg); } 60% { transform: skew(-1deg); } 80% { transform: skew(1deg); } 100% { transform: skew(0deg); } }
        
        .mission-info { text-align: left; border-left: 3px solid var(--accent-green); padding-left: 20px; margin: 2rem 0; color: #888; font-size: 1.2rem;}
        .highlight { color: var(--accent-green); background: rgba(0, 255, 65, 0.1); padding: 0 5px; }

        #slide-briefing { background: #050505; }
        .section-title { font-family: var(--font-tech); font-size: 2rem; color: var(--alert-red); margin-bottom: 2rem; border-bottom: 2px solid var(--alert-red); display: inline-block; padding-bottom: 5px; }
        .box-container { display: flex; gap: 2rem; margin-bottom: 3rem; flex-wrap: wrap; justify-content: center;}
        .data-box { border: 1px solid #333; padding: 20px; background: rgba(255,255,255,0.03); max-width: 400px; text-align: left; position: relative;}
        .data-box h3 { font-family: var(--font-tech); margin-bottom: 10px; color: var(--alert-red); }
        .stamp { 
            border: 4px solid var(--alert-red); color: var(--alert-red); 
            font-family: var(--font-title); font-size: 2rem; 
            padding: 10px 20px; transform: rotate(-10deg); opacity: 0.7; 
            position: absolute; bottom: 10%; right: 10%;
        }

        #slide-mechanics { background: #020202; }
        .mech-title { color: var(--neon-blue); border-color: var(--neon-blue); }
        .gps-mockup { 
            border: 2px dashed var(--neon-blue); padding: 30px; width: 80%; max-width: 500px; 
            margin: 2rem auto; position: relative; background: rgba(0, 247, 255, 0.05);
        }
        .gps-coords { font-family: var(--font-tech); font-size: 1.5rem; color: var(--accent-green); margin-bottom: 10px;}

        /* BUTTONS */
        .action-btn {
            margin-top: 30px;
            font-family: var(--font-tech); font-size: 1.2rem;
            color: #000; background: var(--accent-green);
            border: none; padding: 15px 40px; cursor: pointer;
            letter-spacing: 2px; text-transform: uppercase;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: all 0.3s; position: relative; z-index: 50;
        }
        .action-btn:hover { background: #fff; box-shadow: 0 0 20px var(--accent-green); transform: translateY(-2px); }
        .action-btn.alert { background: var(--alert-red); color: #fff; }
        .action-btn.alert:hover { background: #fff; color: var(--alert-red); box-shadow: 0 0 20px var(--alert-red); }

        /* ================= INTRUSION SLIDE STYLES (NEW) ================= */
        #slide-intrusion { background: #1a0005; }
        #slide-intrusion h1 { color: var(--alert-red); text-shadow: 2px 2px var(--accent-green); font-size: 4rem; margin-bottom: 2rem; }
        .crossed-out { text-decoration: line-through; text-decoration-color: var(--alert-red); text-decoration-thickness: 3px; color: #666; font-size: 1.2rem;}
        .handwritten { font-family: 'Brush Script MT', cursive; color: var(--accent-green); font-size: 3rem; transform: rotate(-5deg); display: block; margin-top: 20px; text-shadow: 0 0 10px var(--accent-green);}
        
        .typewriter {
            overflow: hidden; border-right: .15em solid var(--accent-green);
            white-space: nowrap; margin: 0 auto; letter-spacing: .15em;
            animation: blink-caret .75s step-end infinite;
            font-family: var(--font-tech); color: var(--alert-red); font-size: 1.5rem; margin-bottom: 3rem;
        }
        @keyframes blink-caret { from, to { border-color: transparent } 50% { border-color: var(--accent-green); } }

        .intrusion-box {
            text-align: left; max-width: 600px;
            padding: 2rem; border-left: 5px solid var(--alert-red);
            background: linear-gradient(90deg, rgba(255,0,85,0.1), transparent);
        }

        /* ================= MAP (VOID) ================= */
        #void { background-color: #000; }
        #map-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('./map.jpg'); background-size: cover; background-position: center; filter: grayscale(100%) contrast(150%) brightness(0.4) sepia(20%); z-index: 1; }
        #map-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }
        
        .marker { position: absolute; width: 30px; height: 30px; z-index: 30; cursor: pointer; background: rgba(255, 0, 85, 0.2); border: 1px solid var(--alert-red); box-shadow: 0 0 15px var(--alert-red); transform: rotate(45deg); transition: 0.3s; animation: pulse-marker 2s infinite; }
        .marker:hover { background: var(--alert-red); transform: rotate(45deg) scale(1.2); box-shadow: 0 0 30px var(--alert-red), 0 0 10px #fff inset; }
        @keyframes pulse-marker { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .marker-label { position: absolute; left: 40px; top: -10px; font-size: 10px; font-family: var(--font-mono); color: var(--alert-red); background: #000; border: 1px solid var(--alert-red); padding: 2px 5px; white-space: nowrap; opacity: 0; transition: 0.3s; transform: rotate(-45deg); pointer-events: none; }
        .marker:hover .marker-label { opacity: 1; }

        /* ================= 3D RECONSTRUCTION ================= */
        #reconstruction { background: #000; }
        #three-container { position: absolute; inset: 0; z-index: 1; cursor: grab; }
        #three-container:active { cursor: grabbing; }

        #recon-console {
            position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 500px; z-index: 50; pointer-events: auto;
            text-align: center;
            background: rgba(0, 10, 0, 0.8); border: 1px solid var(--accent-green);
            padding: 20px; backdrop-filter: blur(5px);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.1);
        }
        #recon-console h2 { font-family: var(--font-serif); font-size: 1.5rem; color: #fff; margin-bottom: 1rem; letter-spacing: 2px; text-transform: uppercase;}
        #recon-console p { font-family: var(--font-mono); font-size: 0.7rem; color: var(--accent-green); margin-bottom: 15px;}
        
        .input-area { display: flex; border-bottom: 1px solid var(--accent-green); margin-top: 10px; background: rgba(0,255,65,0.05); }
        input { flex: 1; background: transparent; border: none; color: #fff; padding: 10px; outline: none; font-family: var(--font-mono); }
        .submit-btn { background: transparent; color: var(--accent-green); border: none; cursor: pointer; padding: 0 20px; font-weight: bold; font-family: var(--font-mono); transition:0.3s;}
        .submit-btn:hover { background: var(--accent-green); color: #000; box-shadow: 0 0 15px var(--accent-green);}
        #purge-btn { margin-top: 10px; font-size: 10px; color: #666; cursor: pointer; display: inline-block; border: 1px solid #333; padding: 5px; font-family: var(--font-mono); transition:0.3s;}
        #purge-btn:hover { color: var(--alert-red); border-color: var(--alert-red); background: rgba(255,0,85,0.1); }

        #particles-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 60; }
        .floating-text { position: absolute; color: var(--accent-green); font-size: 0.8rem; animation: floatUp 4s linear forwards; font-family: var(--font-mono); }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-100px) scale(0.5); } }

        #memory-3d-tooltip { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: rgba(0, 0, 0, 0.95); border: 1px solid var(--alert-red); 
            padding: 15px; max-width: 250px; pointer-events: none; 
            opacity: 0; transition: opacity 0.1s; z-index: 1000; 
            box-shadow: 0 0 20px rgba(255, 0, 85, 0.2); text-align: left;
        }
        #tooltip-3d-content { color: #fff; font-family: var(--font-serif); font-size: 1rem; line-height: 1.4; }

        /* TERMINAL OVERLAY */
        .glitch-text { position: relative; display: inline-block; font-family: var(--font-tech); }
        .glitch-text::before, .glitch-text::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.8; }
        .glitch-text::before { color: var(--alert-red); z-index: -1; animation: glitch-shift 0.4s infinite linear alternate-reverse; }
        .glitch-text::after { color: var(--neon-blue); z-index: -2; animation: glitch-shift 0.4s infinite linear alternate-reverse 0.2s; }
        @keyframes glitch-shift { 0% { transform: translate(2px, 0) skew(0deg); } 20% { transform: translate(-2px, 0) skew(2deg); } 40% { transform: translate(0, 2px) skew(0deg); } 60% { transform: translate(2px, -2px) skew(-2deg); } 80% { transform: translate(-2px, 2px) skew(0deg); } 100% { transform: translate(0, 0) skew(0deg); } }

        #fullscreen-stage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            opacity: 0; pointer-events: none; transition: opacity 0.3s steps(5);
            display: flex; justify-content: center; align-items: center;
            background-image: radial-gradient(circle at center, rgba(20,20,20,0.8) 0%, #000 100%);
        }
        #fullscreen-stage.active { opacity: 1; pointer-events: auto; }
        #fullscreen-stage::after { content: ""; position: fixed; inset: 0; pointer-events: none; z-index: 10000; background: repeating-linear-gradient(rgba(0,0,0,0.2) 0, transparent 2px); animation: scanline-scroll 10s linear infinite; }
        @keyframes scanline-scroll { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

        .terminal-window {
            width: 90vw; height: 85vh; background: #050505; border: 2px solid var(--alert-red);
            display: flex; position: relative; overflow: hidden; box-shadow: 0 0 50px rgba(255, 0, 85, 0.2);
            transform: perspective(1000px) rotateX(2deg) rotateY(-1deg); border-radius: 10px;
            flex-direction: column; 
        }
        @media(min-width: 768px) { .terminal-window { flex-direction: row; } }
        
        .terminal-window::before { content: "SYSTEM CRITICAL // DATA CORRUPTION DETECTED"; position: absolute; top: 0; left: 0; width: 100%; background: var(--alert-red); color: #000; font-family: var(--font-tech); font-size: 10px; padding: 2px; text-align: center; animation: flicker 0.5s infinite; z-index: 20; }
        @keyframes flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; background: var(--neon-blue); } }

        .close-terminal { position: absolute; top: 30px; right: 30px; color: var(--alert-red); border: 2px solid var(--alert-red); padding: 10px 20px; font-family: var(--font-tech); font-size: 14px; cursor: pointer; z-index: 100; background: #000; transition: 0.2s; }
        .close-terminal:hover { background: var(--alert-red); color: #000; box-shadow: 0 0 20px var(--alert-red); }

        .terminal-visual { flex: 1.2; position: relative; overflow: hidden; border-right: 3px double var(--alert-red); filter: contrast(120%) brightness(0.9); height: 30vh; }
        @media(min-width: 768px) { .terminal-visual { height: auto; border-right: 3px double var(--alert-red); border-bottom: none; } }

        .glitch-img-container { width: 100%; height: 100%; position: relative; overflow: hidden; }
        .glitch-img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%) contrast(150%) brightness(0.7) sepia(30%); transition: all 0.3s cubic-bezier(0.1, 0.7, 1.0, 0.1); opacity: 0.8; mix-blend-mode: luminosity; }
        .terminal-visual::after { content: ""; position: absolute; inset: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwBAMAAAClIorXAAAAHlBMVEUAAAD///////////////////////////////////8f+B7AAAAAEHRSTlMABg8dHiQvMzY4PkxTVF1+c/4AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAASUlEQVQ4jWNgGAVDBQylMGiAMY0yplEw2AAjCjEIA6YmGGBiYqJgZ2JiZGRgZGRmZsZUZmZgYAAxGUDKGEQYGBgYmBgYGAAAVaYFqQ56270AAAAASUVORK5CYII='); opacity: 0.2; pointer-events: none; animation: noise-shift 0.2s infinite steps(4); z-index: 5;}
        @keyframes noise-shift { 0% {background-position: 0 0;} 100% {background-position: 100px 100px;} }
        .terminal-visual:hover .glitch-img { filter: grayscale(0%) contrast(130%) brightness(1.2); box-shadow: -5px 0 var(--neon-blue), 5px 0 var(--alert-red); animation: strong-glitch 0.2s infinite linear alternate-reverse; transform: scale(1.02) translate(-2px, 2px); }
        @keyframes strong-glitch { 0% { clip-path: inset(10% 0 40% 0); transform: translate(-5px, 2px); } 50% { clip-path: inset(0 30% 20% 0); transform: translate(-2px, 5px); filter: hue-rotate(90deg) contrast(180%);} 100% { clip-path: inset(0 0 0 0); transform: translate(0, 0); filter: hue-rotate(0deg); } }

        .terminal-data { flex: 1; padding: 50px 30px; overflow-y: auto; font-family: var(--font-mono); background: #020202; background-image: linear-gradient(rgba(0, 255, 65, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 65, 0.1) 1px, transparent 1px); background-size: 20px 20px; background-position: -5px -5px; }
        .data-header { border-bottom: 4px solid var(--alert-red); padding-bottom: 20px; margin-bottom: 30px; transform: rotate(-1deg); }
        .data-id { color: var(--alert-red); font-family: var(--font-tech); font-size: 14px; letter-spacing: 4px; animation: flicker 1s infinite; }
        .data-title { font-family: var(--font-tech); font-size: 3rem; color: #fff; margin: 10px 0; text-transform: uppercase; letter-spacing: -2px; }
        .data-block { margin-bottom: 40px; padding: 20px; border: 1px dashed #333; position: relative; transform: rotate(0.5deg); background: rgba(255,255,255,0.02); }
        .data-block:nth-child(even) { transform: rotate(-0.8deg); background: rgba(0,0,0,0.3); border-color: var(--alert-red); }
        .block-label { font-family: var(--font-tech); font-size: 12px; color: var(--accent-green); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid var(--accent-green); display: inline-block;}
        .human-text { color: #ccc; font-family: var(--font-serif); font-size: 1rem; line-height: 1.5; font-style: italic; white-space: pre-wrap; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }
        .history-text { color: #fff; font-family: var(--font-sans); font-size: 0.8rem; line-height: 1.4; border-left: 3px solid #555; padding-left: 10px; background: rgba(255,255,255,0.05); }
        .ai-block { border: 2px solid var(--alert-red); background: rgba(255, 0, 85, 0.15); color: var(--alert-red); font-family: var(--font-tech); font-size: 0.9rem; }
        .ai-text { animation: text-flicker 0.1s infinite alternate; }
        @keyframes text-flicker { 0% { opacity: 1; } 100% { opacity: 0.8; transform: translateX(1px); } }
        @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.3} }
    </style>
</head>
<body>

    <div id="loader">
        <div class="loader-text">SYSTEM BOOTING...</div>
        <div class="loader-bar"><div class="loader-progress"></div></div>
    </div>

    <div id="hud-layer">
        <div class="hud-corner tl"></div><div class="hud-corner tr"></div><div class="hud-corner bl"></div><div class="hud-corner br"></div>
        <div class="scan-line"></div>
        
        <div class="hud-container">
            <div class="hud-trigger" onclick="toggleHud()">CLASSIFIED_INTEL</div>
            <div class="hud-details" id="hud-details">
                <span class="hud-label">>>> PROJECT NAME:</span>
                <span class="hud-value">STACHUS_ABSENCE_PROTOCOL</span><br>
                <span class="hud-label">>>> OPERATIVE:</span>
                <span class="hud-value">RUNXUAN LIU</span><br>
                <span class="hud-label">>>> MISSION:</span>
                <span class="hud-value">ARTISTIC PROJECT 1</span><br>
                <span class="hud-label">>>> SUPERVISOR:</span>
                <span class="hud-value">PROF. DR. COSENTINO</span><br>
                <span class="hud-label">>>> SYSTEM STATUS:</span>
                <span class="hud-value" style="color:#00ff41">STABLE (LOCAL_LAYER)</span>
            </div>
        </div>

        <div class="hud-data-br">LAT/LON: <span id="coords">WAITING GPS...</span></div>
    </div>

    <div class="back-btn" onclick="goBack()">[ < RETURN ]</div>

    <div id="game-container">
        
        <section id="slide-cover" class="game-section active">
            <h1 class="glitch-title">PROJECT<br>STACHUS</h1>
            <div class="mission-info">
                <p>TARGET: KARLSPLATZ_VOID</p>
                <p>OBJECTIVE: <span class="highlight">RECOVER MEMORY</span></p>
                <p>CLEARANCE: TOP SECRET</p>
            </div>
            <button class="action-btn" onclick="navigateTo('slide-briefing')">INITIALIZE SYSTEM</button>
        </section>

        <section id="slide-briefing" class="game-section">
            <h2 class="section-title">MISSION BRIEFING</h2>
            <div class="box-container">
                <div class="data-box">
                    <h3>OFFICIAL DIRECTIVE</h3>
                    <p>"Citizens report anomalies at Stachus. The police department requests immediate deletion of these hallucinations."</p>
                </div>
                <div class="data-box" style="border-color: var(--alert-red);">
                    <h3 style="color: var(--alert-red);">WARNING</h3>
                    <p>Official narrative may be compromised. Proceed with caution. The 'glitches' might be real memories.</p>
                </div>
            </div>
            <div class="stamp">CLASSIFIED</div>
            <button class="action-btn alert" onclick="navigateTo('slide-mechanics')">ACCEPT MISSION</button>
        </section>

        <section id="slide-mechanics" class="game-section">
            <h2 class="section-title mech-title">LBS INTERFACE ACTIVE</h2>
            <p style="color: #888;">Connecting to Satellite...</p>
            <div class="gps-mockup">
                <div style="position: absolute; top: -10px; left: 10px; background: #000; padding: 0 10px; color: var(--neon-blue); font-size: 0.8rem;">GPS SIGNAL: STRONG</div>
                <div class="gps-coords">LAT: 48.13920 | LON: 11.56550</div>
                <p style="font-size: 0.9rem; color: #bbb; margin-top: 20px;">
                    Move physically to intercept signal.<br>
                    <span style="color: var(--accent-green);">> TARGET LOCKED <</span>
                </p>
            </div>
            <button class="action-btn" onclick="navigateTo('void')">ENTER THE VOID</button>
        </section>

        <section id="void" class="game-section">
            <div id="map-bg"></div>
            <canvas id="map-canvas"></canvas>
            
            <div class="marker" style="top: 45%; left: 20%;" onclick="event.stopPropagation(); openTerminal(0)"><div class="marker-label">01: THE LOOP</div></div>
            <div class="marker" style="top: 50%; left: 48%;" onclick="event.stopPropagation(); openTerminal(1)"><div class="marker-label">02: FLUID GHOST</div></div>
            <div class="marker" style="top: 60%; left: 75%;" onclick="event.stopPropagation(); openTerminal(2)"><div class="marker-label">03: IDENTITY WAR</div></div>
            <div class="marker" style="top: 75%; left: 60%;" onclick="event.stopPropagation(); openTerminal(3)"><div class="marker-label">04: DELETED WALL</div></div>
            
            <div class="next-phase-btn" onclick="navigateTo('slide-intrusion')">[ UPLOAD DATA ]</div>
        </section>

        <section id="slide-intrusion" class="game-section">
            <h1>⚠ SYSTEM FAILURE ⚠</h1>
            <p class="typewriter" style="color: var(--alert-red);">UNAUTHORIZED DATA DECRYPTION...</p>
            <div class="intrusion-box">
                <p>>> ANALYZING 'VIRUS'...</p>
                <p>>> RESULT: <span class="crossed-out">MALICIOUS CODE</span></p>
                <span class="handwritten">IT'S HUMAN MEMORY!</span>
                <br>
                <p style="border: 1px solid var(--alert-red); padding: 15px; color: var(--alert-red); background: rgba(255,0,0,0.1); margin-top: 20px;">
                    ALERT: OFFICIAL NARRATIVE IS A LIE.<br>
                    THEY WANT TO ERASE US.
                </p>
            </div>
            <button class="action-btn alert" style="margin-top: 40px;" onclick="navigateTo('reconstruction')">FORCE SYSTEM OVERRIDE</button>
        </section>

        <section id="reconstruction" class="game-section">
            <div id="three-container"></div>
            <div id="recon-console">
                <h2>Memory Reconstruction</h2>
                <p>Inject data to stabilize the structure</p>
                <div class="input-area">
                    <input type="text" id="memory-input" placeholder="Enter missing memory..." autocomplete="off">
                    <button class="submit-btn" onclick="submitMemory()">INJECT</button>
                </div>
                <div id="purge-btn" onclick="purgeMemories()">[ PURGE DATABASE ]</div>
            </div>
            <div id="particles-container"></div>
            <div id="memory-3d-tooltip">
                <div style="color:var(--accent-green); font-size:10px; margin-bottom:5px; font-family:var(--font-mono);">[ MEMORY FRAGMENT ]</div>
                <div id="tooltip-3d-content">...</div>
                <div style="margin-top:5px; font-size:9px; color:#666; font-family:var(--font-mono);">[DEL] TO DELETE</div>
            </div>
        </section>

    </div>

    <div id="fullscreen-stage">
        <div class="terminal-window">
            <div class="close-terminal" onclick="closeTerminal()">[x] ABORT</div>
            <div class="terminal-visual">
                <div class="glitch-img-container"><img id="term-img" class="glitch-img" src="" alt="NO DATA"></div>
            </div>
            <div class="terminal-data">
                <div class="data-header">
                    <div class="data-id glitch-text" id="term-id" data-text="ID">ID</div>
                    <h2 class="data-title glitch-text" id="term-title" data-text="TITLE">TITLE</h2>
                </div>
                <div class="data-block human-block">
                    <div class="block-label">/// HUMAN INPUT</div>
                    <p class="human-text" id="term-human">...</p>
                </div>
                <div class="data-block history-block" style="border-color: #555;">
                    <div class="block-label" style="color: #888; border-color: #555;">/// HISTORICAL FACTS</div>
                    <p class="history-text" id="term-history">...</p>
                </div>
                <div class="data-block ai-block">
                    <div class="block-label" style="color: var(--alert-red); border-color: var(--alert-red);">⚠ SYSTEM FAILURE REPORT (AI)</div>
                    <div class="ai-text" id="term-ai">...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= LOADER & HUD TOGGLE =================
        window.addEventListener('load', () => {
            setTimeout(() => { document.getElementById('loader').style.opacity = '0'; }, 2000);
        });

        function toggleHud() {
            const details = document.getElementById('hud-details');
            const trigger = document.querySelector('.hud-trigger');
            if(details.style.display === 'block') {
                details.style.display = 'none';
                details.classList.remove('visible');
                trigger.classList.remove('active');
            } else {
                details.style.display = 'block';
                setTimeout(() => details.classList.add('visible'), 10);
                trigger.classList.add('active');
            }
        }

        // ================= NAV =================
        const historyStack = ['slide-cover']; 

        function navigateTo(targetId) {
            const current = document.querySelector('.game-section.active');
            if(current) current.classList.remove('active');
            const target = document.getElementById(targetId);
            if(target) target.classList.add('active');

            if(targetId !== historyStack[historyStack.length-1]) { historyStack.push(targetId); }

            const backBtn = document.querySelector('.back-btn');
            if(targetId === 'slide-cover') {
                backBtn.style.display = 'none';
                historyStack.length = 0; historyStack.push('slide-cover');
            } else {
                backBtn.style.display = 'block';
            }

            if(targetId === 'void') { setTimeout(resizeMap, 100); }
            if(targetId === 'reconstruction') {
                setTimeout(() => {
                    if(camera && renderer) {
                        camera.aspect = window.innerWidth / window.innerHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(window.innerWidth, window.innerHeight);
                    }
                }, 100);
            }
        }

        function goBack() {
            if(historyStack.length > 1) {
                historyStack.pop(); 
                const prevId = historyStack[historyStack.length - 1]; 
                document.querySelectorAll('.game-section').forEach(el => el.classList.remove('active'));
                document.getElementById(prevId).classList.add('active');
                if(prevId === 'slide-cover') { document.querySelector('.back-btn').style.display = 'none'; }
            }
        }

        document.addEventListener('mousemove', (e) => { document.getElementById('coords').innerText = (e.clientX).toFixed(0) + ", " + (e.clientY).toFixed(0); });

        // ================= TERMINAL DATA & LOGIC =================
        const archives = [
            { id: "ERR_ARCHIVE_A", title: "THE UNDERGROUND LOOP", img: "./1.jpg", human: "\"I've worked down here for fifteen years...\"", history: "Fact: Built in 1970, Stachus Passagen was Europe's largest underground mall.", ai: "SYSTEM ERROR 1970-XX // All exits are fake screens." },
            { id: "ERR_ARCHIVE_B", title: "THE FLUID GHOST", img: "./2.jpg", human: "\"If you come here at 4 AM, the fountain sounds different...\"", history: "Fact: The fountain was constructed in 1972 for the Olympics.", ai: "FLUID MEMORY ANALYSIS // SOURCE: 18th-Century Emotion." },
            { id: "ERR_ARCHIVE_C", title: "IDENTITY WAR", img: "./3.jpg", human: "\"Karl? Who is Karl? This is Stachus...\"", history: "Fact: Renamed 'Karlsplatz' in 1797.", ai: "IDENTITY CONFLICT // BASE CODE: Stachus (Deep)." },
            { id: "ERR_ARCHIVE_D", title: "THE DELETED WALL", img: "./4.jpg", human: "\"The old maps show a wall here...\"", history: "Fact: Medieval fortifications demolished in 18th century.", ai: "DEFENSE SYSTEM: OFFLINE // GHOST WALL DETECTED." }
        ];

        const termStage = document.getElementById('fullscreen-stage');
        function openTerminal(index) {
            const data = archives[index];
            if(!data) return;
            document.getElementById('term-id').innerText = data.id;
            document.getElementById('term-title').innerText = data.title;
            document.getElementById('term-title').setAttribute('data-text', data.title);
            document.getElementById('term-img').src = data.img;
            document.getElementById('term-human').innerText = data.human;
            document.getElementById('term-history').innerText = data.history;
            document.getElementById('term-ai').innerText = data.ai;
            termStage.classList.add('active');
        }
        function closeTerminal() { termStage.classList.remove('active'); }

        // ================= MAP LOGIC (TOUCH ENABLED) =================
        const mapCanvas = document.getElementById('map-canvas'); 
        const mapCtx = mapCanvas.getContext('2d'); 
        const voidSection = document.getElementById('void');
        let trails = []; 
        let mouseX = -1000, mouseY = -1000; 

        window.addEventListener('resize', resizeMap); 
        function resizeMap() { mapCanvas.width = window.innerWidth; mapCanvas.height = window.innerHeight; } 
        resizeMap(); loopMap();
        
        // --- UNIFIED MAP INPUT HANDLER ---
        function handleMapInput(x, y) {
            const rect = mapCanvas.getBoundingClientRect(); 
            mouseX = x - rect.left; 
            mouseY = y - rect.top; 
            trails.push({ x: mouseX + (Math.random()-0.5)*10, y: mouseY + (Math.random()-0.5)*10, life: 1.0, size: Math.random() * 4 + 2, color: '#ff0000' }); 
            if(trails.length > 100) trails.shift(); 
        }

        // MOUSE
        voidSection.addEventListener('mousemove', (e) => { 
            handleMapInput(e.clientX, e.clientY);
        });

        // TOUCH (PREVENT SCROLL & HANDLE INPUT)
        voidSection.addEventListener('touchmove', (e) => {
            if(e.touches.length > 0) {
                e.preventDefault(); // STOP SCROLLING
                handleMapInput(e.touches[0].clientX, e.touches[0].clientY);
            }
        }, {passive: false});

        voidSection.addEventListener('touchstart', (e) => {
             if(e.touches.length > 0) {
                handleMapInput(e.touches[0].clientX, e.touches[0].clientY);
             }
        }, {passive: false});

        function loopMap() { 
            requestAnimationFrame(loopMap); 
            mapCtx.clearRect(0,0,mapCanvas.width,mapCanvas.height); 
            mapCtx.globalCompositeOperation = 'source-over'; mapCtx.fillStyle = 'rgba(0,0,0,0.95)'; mapCtx.fillRect(0, 0, mapCanvas.width, mapCanvas.height); 
            if (mouseX > -100) { 
                mapCtx.globalCompositeOperation = 'destination-out'; 
                let gradient = mapCtx.createRadialGradient(mouseX, mouseY, 50, mouseX, mouseY, 250); 
                gradient.addColorStop(0, 'rgba(255,255,255,1)'); gradient.addColorStop(1, 'rgba(255,255,255,0)'); 
                mapCtx.beginPath(); mapCtx.arc(mouseX, mouseY, 250, 0, Math.PI*2); mapCtx.fillStyle = gradient; mapCtx.fill(); 
            } 
            mapCtx.globalCompositeOperation = 'source-over'; 
            for(let i=0; i<trails.length; i++) { 
                let p = trails[i]; mapCtx.fillStyle = '#ff0000'; mapCtx.globalAlpha = p.life; 
                mapCtx.beginPath(); mapCtx.arc(p.x, p.y, p.size, 0, Math.PI*2); mapCtx.fill(); 
                p.life -= 0.02; 
            } 
            mapCtx.globalAlpha = 1.0; 
        }

        // ================= 3D LOGIC (MOBILE OPTIMIZED) =================
        let scene, camera, renderer, pointsMesh, memoryGroup, raycaster, mouse;
        let targetRotationY = 0, targetRotationX = 0; 
        let isDragging = false; 
        let previousMousePosition = { x: 0, y: 0 }; 
        const autoRotateSpeed = -0.002;
        let isAutoRotating = false; 
        let autoFocusTargetY = 0; 
        let hoveredObject = null;

        document.getElementById('memory-input').addEventListener('keypress', function (e) { if (e.key === 'Enter') submitMemory(); });
        function submitMemory() { 
            const input = document.getElementById('memory-input'); const val = input.value; if(!val) return;
            const btn = document.querySelector('.submit-btn'); btn.innerText = "PROCESSING..."; 
            const container = document.getElementById('particles-container'); const particle = document.createElement('div'); particle.classList.add('floating-text'); particle.innerText = val; particle.style.left = '50%'; particle.style.top = '20%'; container.appendChild(particle); setTimeout(() => { particle.remove(); }, 4000);
            setTimeout(() => { activateMemory(val); btn.innerText = "INJECT"; input.value = ""; input.placeholder = "DATA SAVED"; }, 500); 
        }

        function initThree() {
            const container = document.getElementById('three-container');
            const isMobile = window.innerWidth < 768;

            scene = new THREE.Scene(); 
            scene.fog = new THREE.FogExp2(0x020202, 0.005); 

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, isMobile ? 40 : 35, isMobile ? 90 : 60); 
            camera.lookAt(0, 10, 0); 
            
            renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
            renderer.setSize(window.innerWidth, window.innerHeight); 
            container.appendChild(renderer.domElement);

            memoryGroup = new THREE.Group(); scene.add(memoryGroup); pointsMesh = new THREE.Group(); 
            pointsMesh.position.y = -15; memoryGroup.position.y = -15;
            raycaster = new THREE.Raycaster(); mouse = new THREE.Vector2();

            generateStructure(isMobile); loadSavedMemories();

            window.addEventListener('keydown', (e) => { if ((e.key === 'Delete' || e.key === 'Backspace') && hoveredObject) removeMemory(hoveredObject); });
            
            // --- UNIFIED INPUT HANDLERS (MOUSE & TOUCH) ---
            function updateMouseVector(clientX, clientY) {
                const rect = container.getBoundingClientRect();
                mouse.x = ((clientX - rect.left) / rect.width) * 2 - 1; 
                mouse.y = -((clientY - rect.top) / rect.height) * 2 + 1;
                
                const tooltip = document.getElementById('memory-3d-tooltip');
                tooltip.style.left = clientX + 20 + 'px'; 
                tooltip.style.top = clientY + 20 + 'px';
            }

            container.addEventListener('mousedown', (e) => { 
                isDragging = true; 
                previousMousePosition = { x: e.clientX, y: e.clientY }; 
            });
            
            document.addEventListener('mouseup', () => { isDragging = false; });
            
            document.addEventListener('mousemove', (e) => {
                updateMouseVector(e.clientX, e.clientY);
                if (isDragging) {
                    targetRotationY += (e.clientX - previousMousePosition.x) * 0.005; 
                    targetRotationX += (e.clientY - previousMousePosition.y) * 0.005;
                    previousMousePosition = { x: e.clientX, y: e.clientY };
                }
            });

            // TOUCH EVENTS
            container.addEventListener('touchstart', (e) => {
                if(e.touches.length === 1) {
                    isDragging = true;
                    previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
                    updateMouseVector(e.touches[0].clientX, e.touches[0].clientY);
                }
            }, {passive: false});

            container.addEventListener('touchmove', (e) => {
                if(isDragging && e.touches.length === 1) {
                    e.preventDefault(); 
                    const touch = e.touches[0];
                    targetRotationY += (touch.clientX - previousMousePosition.x) * 0.005;
                    targetRotationX += (touch.clientY - previousMousePosition.y) * 0.005;
                    previousMousePosition = { x: touch.clientX, y: touch.clientY };
                    updateMouseVector(touch.clientX, touch.clientY);
                }
            }, {passive: false});

            container.addEventListener('touchend', () => { isDragging = false; });

            function animate() {
                requestAnimationFrame(animate);
                const distToCenter = Math.min(Math.sqrt(mouse.x * mouse.x + mouse.y * mouse.y), 1.0);
                const threshold = 0.2; let explosionFactor = 0;
                if(distToCenter > threshold) { explosionFactor = Math.pow((distToCenter - threshold) / (1.0 - threshold), 2) * 1.5; }

                if (isAutoRotating) {
                    targetRotationY += (autoFocusTargetY - targetRotationY) * 0.05;
                    if(Math.abs(targetRotationY - autoFocusTargetY) < 0.01) isAutoRotating = false;
                } else if(!isDragging) {
                    targetRotationY += autoRotateSpeed;
                }

                if(pointsMesh) {
                    pointsMesh.rotation.y += (targetRotationY - pointsMesh.rotation.y) * 0.1;
                    pointsMesh.rotation.x += (targetRotationX - pointsMesh.rotation.x) * 0.1;
                    memoryGroup.rotation.copy(pointsMesh.rotation); 

                    const positions = pointsMesh.geometry.attributes.position.array;
                    const initials = pointsMesh.geometry.attributes.initialPosition.array;
                    const randomDirs = pointsMesh.geometry.attributes.randomDirection.array;

                    for(let i = 0; i < positions.length; i += 3) {
                        const ox = initials[i]; const oy = initials[i+1]; const oz = initials[i+2];
                        const randX = randomDirs[i]; const randY = randomDirs[i+1]; const randZ = randomDirs[i+2];
                        const flyDist = 300 * explosionFactor;
                        const time = Date.now() * 0.001; const breath = 0.5 * Math.sin(time + ox);
                        positions[i] = ox + (randX * flyDist) + breath; positions[i+1] = oy + (randY * flyDist) + breath; positions[i+2] = oz + (randZ * flyDist) + breath;
                    }
                    pointsMesh.geometry.attributes.position.needsUpdate = true;
                }
                
                memoryGroup.children.forEach((mesh, i) => {
                     mesh.rotation.x += 0.01; mesh.rotation.y += 0.02;
                     if (mesh.userData.initialPos) {
                         const init = mesh.userData.initialPos;
                         const flyDist = 50 * explosionFactor; 
                         const dir = new THREE.Vector3(init.x, init.y, init.z).normalize();
                         mesh.position.x = init.x + dir.x * flyDist; mesh.position.y = init.y + dir.y * flyDist; mesh.position.z = init.z + dir.z * flyDist;
                     }
                });

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(memoryGroup.children, true);
                const tooltip = document.getElementById('memory-3d-tooltip');
                
                if (intersects.length > 0) {
                    let crystalMesh = intersects[0].object;
                    while(crystalMesh.parent && crystalMesh.parent !== memoryGroup) { crystalMesh = crystalMesh.parent; }
                    hoveredObject = crystalMesh; 
                    document.body.style.cursor = 'pointer';
                    tooltip.style.opacity = 1; 
                    document.getElementById('tooltip-3d-content').innerText = crystalMesh.userData.text;
                    crystalMesh.scale.setScalar(1.5 + Math.sin(Date.now()*0.02)*0.2); 
                } else {
                    hoveredObject = null; 
                    tooltip.style.opacity = 0; 
                    document.body.style.cursor = 'default';
                    memoryGroup.children.forEach(child => child.scale.setScalar(1));
                }
                renderer.render(scene, camera);
            }
            animate();
            window.addEventListener('resize', () => { 
                camera.aspect = window.innerWidth / window.innerHeight; 
                camera.updateProjectionMatrix(); 
                renderer.setSize(window.innerWidth, window.innerHeight); 
            });
        }

        function getParticleTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 32; canvas.height = 32; const ctx = canvas.getContext('2d');
            ctx.beginPath(); ctx.arc(16, 16, 14, 0, Math.PI*2); ctx.fillStyle = 'white'; ctx.fill();
            const texture = new THREE.Texture(canvas); texture.needsUpdate = true; return texture;
        }

        // --- V7 STRUCTURE GENERATION ---
        function generateStructure(isMobile) {
            const positions = []; const colors = []; const initials = []; const randomDirs = [];
            const baseRadius = 45; const groundLevel = -15;
            
            function getRandomDir() { const v = new THREE.Vector3((Math.random()-0.5), (Math.random()-0.5), (Math.random()-0.5)); v.normalize(); return v; }
            function addPoint(x, y, z) { 
                positions.push(x, y, z); initials.push(x, y, z); 
                colors.push(0.8, 0.8, 0.85); 
                const dir = getRandomDir(); randomDirs.push(dir.x, dir.y, dir.z); 
            }
            
            for(let i=0; i<2500; i++) { const a = (Math.random() - 0.5) * 0.5; const h = groundLevel + Math.random() * 25; const d = Math.random() * 8; if (Math.abs(a) < 0.08 && h < -5) continue; const r = baseRadius - d - 2; const x = Math.cos(a) * r; const z = Math.sin(a) * r; const y = h; addPoint(x, y, z); }
            const wallCount = 4000;
            for(let i=0; i<wallCount; i++) { const side = Math.random() > 0.5 ? 1 : -1; const a = (0.28 + Math.random() * (Math.PI/1.7 - 0.28)) * side; const h = groundLevel + Math.random() * 35; const t = Math.random() * 4; const r = baseRadius + t; const x = Math.cos(a) * r; const z = Math.sin(a) * r; const y = h; addPoint(x, y, z); }
            for(let i = 0; i < 1200; i++) { const theta = Math.random() * Math.PI * 2; const rRatio = Math.sqrt(Math.random()); const x = 18 * rRatio * Math.cos(theta); const z = 30 * rRatio * Math.sin(theta); const y = groundLevel + 0.5; addPoint(x, y, z); }
            for(let i = 0; i < 800; i++) { const a = -Math.PI/1.5 + Math.random() * (Math.PI*1.3); const r = baseRadius + Math.random() * 40; const x = Math.cos(a) * r; const z = Math.sin(a) * r; if ((x*x)/(900) + (z*z)/(324) < 1.5) continue; addPoint(x, groundLevel, z); }
            
            const geometry = new THREE.BufferGeometry(); geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3)); geometry.setAttribute('initialPosition', new THREE.Float32BufferAttribute(initials, 3)); geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3)); geometry.setAttribute('randomDirection', new THREE.Float32BufferAttribute(randomDirs, 3));
            
            const material = new THREE.PointsMaterial({ 
                size: 0.7, 
                vertexColors: true, 
                transparent: true, 
                opacity: 0.9, 
                map: getParticleTexture(), 
                depthWrite: false, 
                sizeAttenuation: true 
            });
            pointsMesh = new THREE.Points(geometry, material); scene.add(pointsMesh); 
        }

        function saveMemories(text, x, y, z, colorHex) {
            let existing = JSON.parse(localStorage.getItem('stachus_memories')) || [];
            existing.push({ text, x, y, z, colorHex });
            localStorage.setItem('stachus_memories', JSON.stringify(existing));
        }
        function loadSavedMemories() {
            let saved = JSON.parse(localStorage.getItem('stachus_memories')) || [];
            saved.forEach(mem => { createMemoryCrystal(mem.text, mem.x, mem.y, mem.z, mem.colorHex); });
        }
        function removeMemory(mesh) {
            if (!mesh) return;
            memoryGroup.remove(mesh);
            let saved = JSON.parse(localStorage.getItem('stachus_memories')) || [];
            const updated = saved.filter(m => m.text !== mesh.userData.text);
            localStorage.setItem('stachus_memories', JSON.stringify(updated));
            hoveredObject = null; document.body.style.cursor = 'default'; document.getElementById('memory-3d-tooltip').style.opacity = 0;
        }
        window.purgeMemories = function() {
            if(confirm("WARNING: SYSTEM PURGE?")) { localStorage.removeItem('stachus_memories'); while(memoryGroup.children.length > 0){ memoryGroup.remove(memoryGroup.children[0]); } }
        };

        function createMemoryCrystal(text, x, y, z, colorHex) {
            const geo = new THREE.IcosahedronGeometry(2.5, 0);
            const mat = new THREE.MeshBasicMaterial({ color: 0xffffff, wireframe: true, transparent: true, opacity: 0.8 });
            const mesh = new THREE.Mesh(geo, mat);
            const glowGeo = new THREE.SphereGeometry(1.3, 16, 16);
            const glowMat = new THREE.MeshBasicMaterial({ color: colorHex });
            const glowMesh = new THREE.Mesh(glowGeo, glowMat);
            mesh.add(glowMesh);
            mesh.position.set(x, y, z); mesh.userData = { text: text, initialPos: {x, y, z} }; 
            memoryGroup.add(mesh);
        }

        function getNeonColor() {
            const hue = Math.random(); const sat = 0.9; const light = 0.6;
            const col = new THREE.Color().setHSL(hue, sat, light); return col.getHex();
        }

        // --- STRICT SPAWN LOGIC: ONLY IN THE WALLS ---
        window.activateMemory = function(text) {
            if(!pointsMesh) return;
            const positions = pointsMesh.geometry.attributes.position.array;
            let attempts = 0;
            while(attempts < 2000) {
                const idx = Math.floor(Math.random() * (positions.length/3));
                let x = positions[idx*3]; 
                let y = positions[idx*3+1]; 
                let z = positions[idx*3+2];
                const radius = Math.sqrt(x*x + z*z);

                if(y > -5 && y < 20 && radius > 35 && radius < 55) {
                    const randomColor = getNeonColor();
                    createMemoryCrystal(text, x, y, z, randomColor);
                    saveMemories(text, x, y, z, randomColor);
                    autoFocusTargetY = -Math.atan2(x, z);
                    isAutoRotating = true; 
                    return;
                }
                attempts++;
            }
        };

        initThree();
    </script>
</body>
</html>
